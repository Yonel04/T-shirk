/*! Lifesight.js v0.0.1 | MIT License */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).lifesight=t()}(this,(function(){"use strict";var e,t=new Uint8Array(16);function i(){if(!e&&!(e="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return e(t)}for(var n=[],r=0;r<256;++r)n.push((r+256).toString(16).slice(1));var o={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function a(e,t,r){if(o.randomUUID&&!t&&!e)return o.randomUUID();var a=(e=e||{}).random||(e.rng||i)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(var s=0;s<16;++s)t[r+s]=a[s];return t}return function(e,t){return void 0===t&&(t=0),n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]}(a)}var s={set:function(e,t,i,n){var r="",o="";if(i){var a=new Date;a.setTime(a.getTime()+60*i*1e3),r="; expires="+a.toGMTString()}n&&(o="; domain="+n),document.cookie=e+"="+escape(t)+r+o+"; path=/; samesite=lax"},get:function(e){var t,i,n=e+"=",r=document.cookie.split(";");for(t=0;t<r.length;t++){for(i=r[t];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(n))return unescape(i.substring(n.length,i.length))}return null}},l={config:{urlPrefix:"",visitsUrl:"https://moda-cdp-message-prd-7jirubb0.uc.gateway.dev/publish-message?key=AIzaSyCfAbq2PsnhrrUFn6aoytqm2oDSE-yyfBc",eventsUrl:"https://moda-cdp-message-prd-7jirubb0.uc.gateway.dev/publish-message?key=AIzaSyCfAbq2PsnhrrUFn6aoytqm2oDSE-yyfBc",domain:window.location.origin,platform:"web",useBeacon:!1,startOnReady:!0,trackVisits:!0,enableAutoPageViews:!0,cookies:!0,cookieDomain:window.location.origin,headers:{},visitParams:{},withCredentials:!1,visitDuration:1440,visitorDuration:1051200},parseQuerystring:function(){if(window.location.href.split("?").length<2)return{};for(var e=window.location.href.split("?")[1].split("#")[0].split("&"),t={},i=[],n=e.length-1;n>=0;n--)t[(i=e[n].split("="))[0]]=i[1];return t},getEphemeralTags:function(){var e=this.parseQuerystring();return{fbclid:e.hasOwnProperty("fbclid")?e.fbclid:"",gclid:e.hasOwnProperty("gclid")?e.gclid:"",msclkid:e.hasOwnProperty("msclkid")?e.msclkid:"",ttclid:e.hasOwnProperty("ttclid")?e.ttclid:"",fbp:s.get("_fbp")?s.get("_fbp"):"",fbc:s.get("_fbc")?s.get("_fbc"):"",gid:s.get("_gid")?s.get("_gid"):"",ttp:s.get("_ttp")?s.get("_ttp"):""}},getUserIP:function(){if(!sessionStorage.getItem("userIP")){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&(sessionStorage.setItem("userIP",this.responseText),window.dispatchEvent(new CustomEvent("ipReceived")))},e.open("GET","https://api.ipify.org/",!0),e.send()}}},c={generateMsgId:function(){var e=a();return lifesight.msgIdQueue.indexOf(e)>-1?"false":(lifesight.msgIdQueue.push(e),lifesight.msgIdQueue.length>19&&lifesight.msgIdQueue.pop(),e)},generatePayload:function(e,t){var i=sessionStorage.getItem("userIP");i||l.getUserIP();lifesight.identifyPayload||(lifesight.identifyPayload={});var n=JSON.parse(localStorage.getItem("lifesight_identify")||s.get("lifesight_identify")),r=Object.assign({},{customer_id:"",email:"",phone:"",customer_name:"",customer_first_name:"",customer_last_name:""},n),o={identifiers:{customer_id:lifesight.identifyPayload.hasOwnProperty("customer_id")?lifesight.identifyPayload.customer_id:r.customer_id,email:lifesight.identifyPayload.hasOwnProperty("email")?lifesight.identifyPayload.email:r.email,phone:lifesight.identifyPayload.hasOwnProperty("phone")?lifesight.identifyPayload.phone:r.phone},customer_name:lifesight.identifyPayload.hasOwnProperty("customer_name")?lifesight.identifyPayload.customer_name:r.customer_name,customer_first_name:lifesight.identifyPayload.hasOwnProperty("customer_first_name")?lifesight.identifyPayload.customer_first_name:r.customer_first_name,customer_last_name:lifesight.identifyPayload.hasOwnProperty("customer_last_name")?lifesight.identifyPayload.customer_last_name:r.customer_last_name,user_agent:window.navigator.userAgent,message_id:this.generateMsgId(),event_timestamp:(new Date).toISOString(),ephemeral_identifiers:l.getEphemeralTags(),shop:l.config.domain,source:l.config.platform,message_type:e,isBulk:!1,event_name:t,session_id:lifesight.getVisitId(),page_view_counter:1,queries:l.parseQuerystring(),context:{ip:i||"",locale:window.navigator.language||"",page_path:window.location.pathname||"",page_title:document.title||"",page_url:window.location.href||"",user_agent:window.navigator.userAgent,page_referrer:document.referrer||"",page_search:window.location.search||""}},a=Object.assign({},o,r);return a.identifiers.anonymous_id=lifesight.getVisitorId(),a}},g=window.lifesight||window.lifesight||{},u=l.config;g.msgIdQueue=[],g.trackEventQueue=JSON.parse(localStorage.getItem("trackEventQueue"))||[],g.configure=function(e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(u[t]=e[t])},g.configure(g);var f,d,h,m,p=window.jQuery||window.Zepto||window.$,v=!1,y=[],_="undefined"!=typeof JSON&&void 0!==JSON.stringify,w=[];function S(e,t,i){s.set(e,t,i,u.cookieDomain||u.domain)}function k(e){return s.get(e)}function I(e){s.set(e,"",-1)}function b(e){("t"===localStorage.getItem("lifesight_debug")||k("lifesight_debug"))&&window.console.log(e)}function P(){for(var e;e=y.shift();)e();v=!0}function O(e,t){var i=e.matches||e.matchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector||e.webkitMatchesSelector;return i?i.apply(e,[t])?e:e.parentElement?O(e.parentElement,t):null:(b("Unable to match"),null)}function E(e,t,i){document.addEventListener(e,(function(e){var n=O(e.target,t);if(n){var r=L(n,"data-lifesight-skip");if(null!==r&&"false"!==r)return;i.call(n,e)}}))}function V(){return a()}function U(e){var t,i=(t=document.querySelector("meta[name=csrf-token]"))&&t.content;i&&e.setRequestHeader("X-CSRF-Token",i)}function Q(e,t,i){if(!(t&&"false"===t.message_id||t&&!t.identifiers.anonymous_id)&&!(t&&t.user_agent.toLowerCase().indexOf("bot")>-1)&&_)if(p&&p.ajax)p.ajax({type:"POST",url:e,data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:U,success:i,headers:u.headers,xhrFields:{withCredentials:u.withCredentials}});else{var n=new XMLHttpRequest;for(var r in n.open("POST",e,!0),n.withCredentials=u.withCredentials,n.setRequestHeader("Content-Type","application/json"),u.headers)Object.prototype.hasOwnProperty.call(u.headers,r)&&n.setRequestHeader(r,u.headers[r]);n.onload=function(){200===n.status&&i()},U(n),n.send(JSON.stringify(t))}}function T(e){g.ready((function(){Q(u.urlPrefix+u.eventsUrl,function(e){var t=e;return u.cookies&&(t.visit_token=e.visit_token,t.visitor_token=e.visitor_token,t.shop=u.domain),delete e.visit_token,delete e.visitor_token,t}(e),(function(){for(var t=0;t<w.length;t++)if(w[t].id===e.id){w.splice(t,1);break}u.cookies&&_&&(S("lifesight_events",JSON.stringify(w),1),localStorage.setItem("lifesight_events",JSON.stringify(w)))}))}))}function x(){return u.page||window.location.pathname}function j(e){return e&&e.length>0?e:null}function C(){return function(e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&null===e[t]&&delete e[t];return e}({tag:this.tagName.toLowerCase(),id:j(this.id),class:j(this.className),page:x(),section:L(this,"data-section")})}function L(e,t){for(;e&&e!==document;e=e.parentNode)if(e.hasAttribute(t))return e.getAttribute(t);return null}function D(){if(v=!1,f=g.getVisitId(),d=g.getVisitorId(),h=localStorage.getItem("lifesight_track")||k("lifesight_track"),!1===u.cookies||!1===u.trackVisits)b("Visit tracking disabled"),P();else if(f&&!h)b("Active visit || Returning User"),P();else if(f||(S("lifesight_visit",f=V(),u.visitDuration),localStorage.setItem("lifesight_visit",f)),!localStorage.getItem("lifesight_visit")&&!k("lifesight_visit")||localStorage.getItem("lifesight_visitor"))b("Cookies disabled"),P();else{b("Visit started"),d||(S("lifesight_visitor",d=V(),u.visitorDuration),localStorage.setItem("lifesight_visitor",d));var e=c.generatePayload("identify","identify");for(var t in document.referrer.length>0&&(e.referrer=document.referrer),u.visitParams)Object.prototype.hasOwnProperty.call(u.visitParams,t)&&(e[t]=u.visitParams[t]);b(e),Q(u.urlPrefix+u.visitsUrl,e,(function(){I("lifesight_track"),localStorage.removeItem("lifesight_track"),P()}))}}function N(){var e=history.pushState;e&&(history.pushState=function(t,i,n){e.apply(this,[t,i,n]),g.pageView()},addEventListener("popstate",g.pageView())),u&&u.enableAutoPageViews&&addEventListener("hashchange",g.pageView()),window.addEventListener("beforeunload",(function(){e&&(history.pushState=e,removeEventListener("popstate",x)),u&&u.enableAutoPageViews&&removeEventListener("hashchange",x),localStorage.removeItem("lifesight_visit"),localStorage.removeItem("trackEventQueue")})),window.addEventListener("unload",(function(){e&&(history.pushState=e,removeEventListener("popstate",x)),u&&u.enableAutoPageViews&&removeEventListener("hashchange",x),localStorage.removeItem("lifesight_visit"),localStorage.removeItem("trackEventQueue")}),!1)}g.ready=function(e){v?e():y.push(e)},g.getVisitId=g.getVisitToken=function(){return localStorage.getItem("lifesight_visit")||k("lifesight_visit")},g.getVisitorId=g.getVisitorToken=function(){return localStorage.getItem("lifesight_visitor")||k("lifesight_visitor")},g.reset=function(){return I("lifesight_visit"),I("lifesight_visitor"),I("lifesight_events"),I("lifesight_track"),localStorage.removeItem("lifesight_visit"),localStorage.removeItem("lifesight_visitor"),localStorage.removeItem("lifesight_events"),localStorage.removeItem("lifesight_track"),!0},g.debug=function(e){return!1===e?(I("lifesight_debug"),localStorage.removeItem("lifesight_debug")):(S("lifesight_debug","t",525600),localStorage.setItem("lifesight_debug","t")),!0},g.track=function(e,t){var i=c.generatePayload("track",e);return"page_view"===e?(i.properties=t||{},g.trackEventQueue.push(t&&t.page?t.page:""),localStorage.setItem("trackEventQueue",JSON.stringify(g.trackEventQueue))):i=Object.assign({},i,t),g.ready((function(){u.cookies&&!g.getVisitId()&&D(),g.ready((function(){b(i),i.visit_token=g.getVisitId(),i.visitor_token=g.getVisitorId(),T(i)}))})),!0},g.identify=function(e){e||(e={}),g.identifyPayload=e,S("lifesight_identify",JSON.stringify(e)),localStorage.setItem("lifesight_identify",JSON.stringify(e));var t=c.generatePayload("identify","identify");return g.ready((function(){u.cookies&&!g.getVisitId()&&D(),g.ready((function(){b(t),t.visit_token=g.getVisitId(),t.visitor_token=g.getVisitorId(),T(t)}))})),!0},g.pageView=function(e){var t={url:window.location.href,title:document.title,page:x()};if(e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);g.trackEventQueue.indexOf(t.page)>-1||(g.trackEventQueue.pop(),localStorage.setItem("trackEventQueue",JSON.stringify(g.trackEventQueue)),g.track("page_view",t))},g.trackClicks=function(e){if(void 0===e)throw new Error("Missing selector");E("click",e,(function(e){var t=C.call(this,e);t.text="input"===t.tag?this.value:(this.textContent||this.innerText||this.innerHTML).replace(/[\s\r\n]+/g," ").trim(),t.href=this.href,g.track("$click",t)}))},g.trackSubmits=function(e){if(void 0===e)throw new Error("Missing selector");E("submit",e,(function(e){var t=C.call(this,e);g.track("$submit",t)}))},g.trackChanges=function(e){if(void 0===e)throw new Error("Missing selector");E("change",e,(function(e){var t=C.call(this,e);g.track("$change",t)}))};try{w=JSON.parse(localStorage.getItem("lifesight_events")||"[]")}catch(e){}return g.start=function(){D(),g.start=function(){}},m=function(){u.startOnReady&&(l.getUserIP(),sessionStorage.getItem("userIP")?(g.start(),N()):window.addEventListener("ipReceived",(function(){g.start(),N()})))},"interactive"===document.readyState||"complete"===document.readyState?setTimeout(m,0):document.addEventListener("DOMContentLoaded",m),g}));
